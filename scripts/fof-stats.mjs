export const monsterStats = {
	"CR 0": {"acdc": 10, "hp": "3 (2-4)", "atkprof": "2", "dpr": "2", "atks": 1, "dmg": "2 (1d4)"},
	"CR 1/8": {"acdc": 11, "hp": "9 (7-11)", "atkprof": "3", "dpr": "3", "atks": 1, "dmg": "4 (1d6 + 1)"},
	"CR 1/4": {"acdc": 11, "hp": "13 (10-16)", "atkprof": "3", "dpr": "5", "atks": 1, "dmg": "5 (1d6 + 2)"},
	"CR 1/2": {"acdc": 12, "hp": "22 (17-28)", "atkprof": "4", "dpr": "8", "atks": 2, "dmg": "4 (1d4 + 2)"},
	"CR 1": {"acdc": 12, "hp": "33 (25-41)", "atkprof": "5", "dpr": "12", "atks": 2, "dmg": "6 (1d8 + 2)"},
	"CR 2": {"acdc": 13, "hp": "45 (34-56)", "atkprof": "5", "dpr": "17", "atks": 2, "dmg": "9 (2d6 + 2)"},
	"CR 3": {"acdc": 13, "hp": "65 (49-81)", "atkprof": "5", "dpr": "23", "atks": 2, "dmg": "12 (2d8 + 3)"},
	"CR 4": {"acdc": 14, "hp": "84 (64-106)", "atkprof": "6", "dpr": "28", "atks": 2, "dmg": "14 (3d8 + 1)"},
	"CR 5": {"acdc": 15, "hp": "95 (71-119)", "atkprof": "7", "dpr": "35", "atks": 3, "dmg": "12 (3d6 + 2)"},
	"CR 6": {"acdc": 15, "hp": "112 (84-140)", "atkprof": "7", "dpr": "41", "atks": 3, "dmg": "14 (3d6 + 4)"},
	"CR 7": {"acdc": 15, "hp": "130 (98-162)", "atkprof": "7", "dpr": "47", "atks": 3, "dmg": "16 (3d8 + 3)"},
	"CR 8": {"acdc": 15, "hp": "136 (102-170)", "atkprof": "7", "dpr": "53", "atks": 3, "dmg": "18 (3d10 + 2)"},
	"CR 9": {"acdc": 16, "hp": "145 (109-181)", "atkprof": "8", "dpr": "59", "atks": 3, "dmg": "22 (3d12 + 3)"},
	"CR 10": {"acdc": 17, "hp": "155 (116-194)", "atkprof": "9", "dpr": "65", "atks": 4, "dmg": "16 (3d8 + 3)"},
	"CR 11": {"acdc": 17, "hp": "165 (124-206)", "atkprof": "9", "dpr": "71", "atks": 4, "dmg": "18 (3d10 + 2)"},
	"CR 12": {"acdc": 17, "hp": "175 (131-219)", "atkprof": "9", "dpr": "77", "atks": 4, "dmg": "19 (3d10 + 3)"},
	"CR 13": {"acdc": 18, "hp": "184 (138-230)", "atkprof": "10", "dpr": "83", "atks": 4, "dmg": "21 (4d8 + 3)"},
	"CR 14": {"acdc": 19, "hp": "196 (147-245)", "atkprof": "11", "dpr": "89", "atks": 4, "dmg": "22 (4d10)"},
	"CR 15": {"acdc": 19, "hp": "210 (158-263)", "atkprof": "11", "dpr": "95", "atks": 5, "dmg": "19 (3d10 + 3)"},
	"CR 16": {"acdc": 19, "hp": "229 (172-286)", "atkprof": "11", "dpr": "101", "atks": 5, "dmg": "21 (4d8 + 3)"},
	"CR 17": {"acdc": 20, "hp": "246 (185-308)", "atkprof": "12", "dpr": "107", "atks": 5, "dmg": "22 (3d12 + 3)"},
	"CR 18": {"acdc": 21, "hp": "266 (200-333)", "atkprof": "13", "dpr": "113", "atks": 5, "dmg": "23 (4d10 + 1)"},
	"CR 19": {"acdc": 21, "hp": "285 (214-356)", "atkprof": "13", "dpr": "119", "atks": 5, "dmg": "24 (4d10 + 2)"},
	"CR 20": {"acdc": 21, "hp": "300 (225-375)", "atkprof": "13", "dpr": "132", "atks": 5, "dmg": "26 (4d12)"},
	"CR 21": {"acdc": 22, "hp": "325 (244-406)", "atkprof": "14", "dpr": "150", "atks": 5, "dmg": "30 (4d12 + 4)"},
	"CR 22": {"acdc": 23, "hp": "350 (263-438)", "atkprof": "15", "dpr": "168", "atks": 5, "dmg": "34 (4d12 + 8)"},
	"CR 23": {"acdc": 23, "hp": "375 (281-469)", "atkprof": "15", "dpr": "186", "atks": 5, "dmg": "37 (6d10 + 4)"},
	"CR 24": {"acdc": 23, "hp": "400 (300-500)", "atkprof": "15", "dpr": "204", "atks": 5, "dmg": "41 (6d10 + 8)"},
	"CR 25": {"acdc": 24, "hp": "430 (323-538)", "atkprof": "16", "dpr": "222", "atks": 5, "dmg": "44 (6d10 + 11)"},
	"CR 26": {"acdc": 25, "hp": "460 (345-575)", "atkprof": "17", "dpr": "240", "atks": 5, "dmg": "48 (6d10 + 15)"},
	"CR 27": {"acdc": 25, "hp": "490 (368-613)", "atkprof": "17", "dpr": "258", "atks": 5, "dmg": "52 (6d10 + 19)"},
	"CR 28": {"acdc": 25, "hp": "540 (405-675)", "atkprof": "17", "dpr": "276", "atks": 5, "dmg": "55 (6d10 + 22)"},
	"CR 29": {"acdc": 26, "hp": "600 (450-750)", "atkprof": "18", "dpr": "294", "atks": 5, "dmg": "59 (6d10 + 26)"},
	"CR 30": {"acdc": 27, "hp": "666 (500-833)", "atkprof": "19", "dpr": "312", "atks": 5, "dmg": "62 (6d10 + 29)"}
};

export async function newFofActor(formData){
	if(formData.monsterName.trim() === ''){
		formData.monsterName = 'New Monster'
	}

	const selStats = monsterStats[formData.crSelect];

	const newActor = await Actor.create({
        name: formData.monsterName,
        type: "npc"
    });
	//placeholder object to edit changes
	const dummy = {...newActor};

	//set CR
	const crValue = formData.crSelect.match(/[\d\/]+/)[0];
	if (crValue.includes("/")) {
		dummy.system.attributes.cr = parseFraction(crValue);
	} else {
		dummy.system.attributes.cr = parseInt(crValue);
	}

	//set AC
	assignToObject(dummy,"system.attributes.ac.baseFormulas",new Set([ "natural" ]));
    assignToObject(dummy,"system.attributes.ac.flat",selStats.acdc);


	//set HP
	const hpValue = parseInt(selStats.hp.match(/^\d*/)[0]);
	assignToObject(dummy,"system.attributes.hp.max",hpValue);
    assignToObject(dummy,"system.attributes.hp.value",hpValue);

	//Set abilities
	for(const ability of formData["abilities[]"]){
		if(ability){
			assignToObject(dummy,`system.abilities.${ability}.proficient`,true);
			assignToObject(dummy,`system.abilities.${ability}.mod`,abilityAssign(newActor.system.attributes.cr, selStats.atkprof));
		}
	}

	//Set Stealth and Perception
	assignToObject(dummy,'system.attributes.stealth', 10 + ((dummy.system.abilities?.dexterity.mod)? dummy.system.abilities.dexterity.mod : 0));
	assignToObject(dummy,'system.attributes.perception', 10 + ((dummy.system.abilities?.wisdom.mod)? dummy.system.abilities.wisdom.mod : 0));

	//Add modifications to new actor
	await newActor.update(dummy);

	//set Attack
	//If it has more than 1 attack per turn, set the multiattack feature
	if(selStats.atks > 1){
		await newActor.createEmbeddedDocuments("Item",[{ name:"Multiattack", type: "feature", 
			system: { description: { value: `The ${newActor.name} makes ${selStats.atks} attacks.`}, 
			activities: newActivity("utility", "action")}}]);
	}
	//get damage value rolls
	const dmgValue = /\(((?<dicenum>\d*)d(?<dicedenom>\d*))(.\+.(?<bonus>\d*))?\)/.exec(selStats.dmg)//get damage value
	//Set main attack
	const newAtk = {"system":{"attack":{"bonus":selStats.atkprof, "flat": true}, "damage":{"parts":[{"additionalTypes": [ ], "bonus": (dmgValue.groups?.bonus)? dmgValue.groups.bonus : "", "custom": { "enabled": false, "formula": "" }, "denomination": parseInt(dmgValue.groups.dicedenom), "number": parseInt(dmgValue.groups.dicenum), "scaling": { "number": 1 }, "type": ""}]}}}

	await newActor.createEmbeddedDocuments("Item",[{ name:"Attack", type: "feature", 
		system: { description: { value: `<em>Melee or Ranged Weapon Attack:</em> [[/attack]] reach 5 ft. or range 60 ft., one target. <em>Hit:</em> [[/damage average]] damage`}, 
		activities: newActivity("attack", "action", newAtk)}}]);
}



function parseFraction(string) {
    let result = null;
    const numbers = string.split("/");

    if (numbers.length == 2) {
        const numerator = parseFloat(numbers[0]);
        const denominator = parseFloat(numbers[1]);
        result = numerator / denominator;
    }

    return result;
}

function assignToObject(obj, path, val) {
    const pathArr = path.split(".");

    let length = pathArr.length;
    let current = obj;

    for (let i = 0; i < pathArr.length; i++) {
        const key = pathArr[i];

        // If this is the last item in the loop, assign the value
        if (i === length - 1) {
            current[key] = val;
        } else {
            // If the key doesn't exist, create it
            if (!current[key]) {
                current[key] = {};
            }

            current = current[key];
        }
    }

    return obj;
}

function abilityAssign(cr,crprof){

	if(cr === 0){
		return 1;
	}

	return parseInt(crprof);

}

//Templates for objects
const activityTemplates = {
    'attack' : { "type": "attack", "description": "", "sort": 0, "system": { "attack": { "critical": { "threshold": null }, "flat": false, "type": { "value": "melee", "classification": "weapon" }, "ability": "", "bonus": "" }, "damage": { "critical": { "bonus": "" }, "includeBase": true, "parts": [] }, "effects": [] }, "activation": { "value": null, "override": false, "primary": true, "type": "action", "condition": "" }, "consumption": { "targets": [], "scale": { "allowed": false } }, "duration": { "units": "instantaneous", "concentration": false, "override": false }, "range": { "override": false, "units": "" }, "magical": false, "target": { "template": { "contiguous": false, "units": "foot", "type": "" }, "affects": { "choice": false, "type": "" }, "prompt": false, "override": false }, "uses": { "spent": 0, "consumeQuantity": false, "recovery": [], "max": "" }, "name": "", "img": "" },
    'utility': { "type": "utility", "description": "", "sort": 0, "system": { "effects": [], "roll": { "prompt": false, "visible": false } }, "activation": { "value": null, "override": false, "primary": true }, "consumption": { "targets": [], "scale": { "allowed": false } }, "duration": { "units": "instantaneous", "concentration": false, "override": false }, "range": { "override": false }, "magical": false, "target": { "template": { "contiguous": false, "units": "foot" }, "affects": { "choice": false }, "prompt": true, "override": false }, "uses": { "spent": 0, "consumeQuantity": false, "recovery": [] } },
    'spellConsume': { "type": "utility", "description": "", "flags": {}, "sort": 0, "system": { "effects": [], "roll": { "prompt": false, "visible": false, "formula": "", "name": "" } }, "activation": { "value": null, "override": false, "primary": true }, "consumption": { "targets": [ { "type": "activity", "value": "1", "scaling": {} } ], "scale": { "allowed": false } }, "duration": { "units": "instantaneous", "concentration": false, "override": false }, "range": { "override": false }, "magical": false, "target": { "template": { "contiguous": false, "units": "foot" }, "affects": { "choice": false }, "prompt": true, "override": false }, "uses": { "spent": 0, "consumeQuantity": false, "recovery": [], "max": "" }, "name": "Consume", "img": "" }
}

function newActivity(type, activation, override = {}){
    const newActivityId = foundry.utils.randomID();
    const newActivityData = {...activityTemplates[type], ...override};

    newActivityData._id=newActivityId;
    newActivityData.type = type;
    newActivityData.activation.type = activation;

    return { [newActivityId] : newActivityData };
}